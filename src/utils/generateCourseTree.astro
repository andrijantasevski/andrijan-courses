---
import type { Course, Lesson, Module } from "src/types/types";
import { cleanUpUrlFromContentAndMDX } from "./generateCourseTree";

export async function generateCourseTree(course: string) {
  const courses = await Astro.glob<Course>("/content/courses/*/index.mdx");

  const modules = await Astro.glob<Module>("/content/courses/*/*/index.mdx");

  const lessons = await Astro.glob<Lesson>("/content/courses/*/*/*.mdx");

  const coursesObjects = courses.map((course) => {
    return {
      courseUrl: cleanUpUrlFromContentAndMDX(course.url ?? ""),
      courseTitle: course.frontmatter.courseTitle,
    };
  });

  const modulesObjects = modules.map((module) => {
    return {
      moduleUrl: cleanUpUrlFromContentAndMDX(module.url ?? ""),
      moduleTitle: module.frontmatter.moduleTitle,
      moduleOrder: module.frontmatter.moduleOrder
    };
  });

  const lessonsObjects = lessons.map((lesson) => {
    if (!lesson.url?.includes("index.mdx")) {
      return {
        lessonUrl: cleanUpUrlFromContentAndMDX(lesson.url ?? ""),
        lessonTitle: lesson.frontmatter.lessonTitle,
        lessonOrder: lesson.frontmatter.lessonOrder,
      };
    }
  });

  const coursesData = coursesObjects.map((course) => {
    const modulesPerCourse = modulesObjects.filter((module) =>
      module.moduleUrl.includes(course.courseUrl)
    );

    const modules = modulesPerCourse.map((module) => {
      const filteredLessons = lessonsObjects.filter((lesson) =>
        lesson?.lessonUrl?.includes(module.moduleUrl)
      );

      const sortedLessons = filteredLessons.sort((a, b) => a?.lessonOrder - b?.lessonOrder)

      return {
        ...module,
        lessons: filteredLessons,
      };
    });

    return {
      course,
      modules,
    };
  });

  return coursesData;
}
---
